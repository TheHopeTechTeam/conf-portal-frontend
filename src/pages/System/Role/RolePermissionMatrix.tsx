import { permissionService } from "@/api/services/permissionService";
import { AdminResourceType, resourceService, type ResourceMenuItem } from "@/api/services/resourceService";
import { verbService, type VerbItem } from "@/api/services/verbService";
import type { PermissionListItem } from "@/api/types";
import Checkbox from "@/components/ui/checkbox";
import { resolveIcon } from "@/utils/icon-resolver";
import { useCallback, useEffect, useMemo, useState } from "react";
import Tooltip from "@/components/ui/tooltip";

type PermissionMatrixProps = {
  value: string[]; // selected permission IDs
  onChange: (ids: string[]) => void;
  className?: string;
};

type PermissionMap = Record<string, Record<string, string | undefined>>; // resourceId -> verbId -> permissionId

export default function RolePermissionMatrix({ value, onChange, className = "" }: PermissionMatrixProps) {
  const [resources, setResources] = useState<ResourceMenuItem[]>([]);
  const [verbs, setVerbs] = useState<VerbItem[]>([]);
  const [permMap, setPermMap] = useState<PermissionMap>({});
  const [loading, setLoading] = useState(false);
  const [permInfoById, setPermInfoById] = useState<Record<string, { code: string }>>({});

  const loadData = useCallback(async () => {
    try {
      setLoading(true);
      const [vr, rr, pr] = await Promise.all([verbService.list(), resourceService.getResources(false), permissionService.list()]);
      if (vr.success) setVerbs(vr.data.items || []);
      if (rr.success) setResources(rr.data.items || []);
      if (pr.success) {
        const items: PermissionListItem[] = Array.isArray(pr.data) ? pr.data : pr.data?.items || [];
        const map: PermissionMap = {};
        const info: Record<string, { code: string }> = {};
        // 建立輔助索引：resource code/key -> id、verb action -> id
        const resourceIndexByCode: Record<string, string> = {};
        const resourceIndexByName: Record<string, string> = {};
        (rr.success ? rr.data.items : []).forEach((r: ResourceMenuItem) => {
          if (r?.code) resourceIndexByCode[String(r.code).toLowerCase()] = r.id;
          if (r?.key) resourceIndexByCode[String(r.key).toLowerCase()] ||= r.id;
          if (r?.name) resourceIndexByName[String(r.name).toLowerCase()] = r.id;
        });
        const verbIndexByAction: Record<string, string> = {};
        const verbIndexByName: Record<string, string> = {};
        (vr.success ? vr.data.items : []).forEach((v: VerbItem) => {
          if (v?.action) verbIndexByAction[String(v.action).toLowerCase()] = v.id;
          if (v?.displayName) verbIndexByName[String(v.displayName).toLowerCase()] = v.id;
        });

        items.forEach((p) => {
          // PermissionListItem 保證有 resourceId 和 verbId
          let resourceId: string | undefined = p.resourceId;
          let verbId: string | undefined = p.verbId;

          // 後備策略：從 code 解析 resource/verb（以防萬一資料不完整）
          if ((!resourceId || !verbId) && p.code.includes(":")) {
            const [codePrefixRaw, actionRaw] = p.code.split(":");
            const codePrefix = codePrefixRaw.toLowerCase();
            const action = actionRaw.toLowerCase();
            if (!resourceId) resourceId = resourceIndexByCode[codePrefix];
            if (!verbId) verbId = verbIndexByAction[action];
          }

          if (!resourceId || !verbId) {
            console.warn(`Permission skipped: code=${p.code}, resourceId=${resourceId}, verbId=${verbId}`, p);
            return;
          }

          if (!map[resourceId]) map[resourceId] = {};
          map[resourceId][verbId] = p.id;
          info[p.id] = { code: p.code || p.displayName || "" };
        });
        setPermMap(map);
        setPermInfoById(info);
      }
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    void loadData();
  }, [loadData]);

  const togglePermission = (permissionId?: string) => {
    if (!permissionId) return;
    const set = new Set(value);
    if (set.has(permissionId)) set.delete(permissionId);
    else set.add(permissionId);
    onChange([...set]);
  };

  // 建立樹狀結構與拍平列（按類型分組）
  type TreeNode = ResourceMenuItem & { children: TreeNode[] };

  // 構建樹狀結構的輔助函數
  const buildTree = useCallback((resourceList: ResourceMenuItem[]): TreeNode[] => {
    const byId: Record<string, TreeNode> = {};
    resourceList.forEach((r) => (byId[r.id] = { ...r, children: [] }));
    const roots: TreeNode[] = [];
    resourceList.forEach((r) => {
      const node = byId[r.id];
      const pid = r.pid || r.parent?.id;
      if (pid && byId[pid]) byId[pid].children.push(node);
      else roots.push(node);
    });
    // 照資源管理方式排序：先依 sequence（越小越前），再依 name
    const sortNodes = (nodes: TreeNode[]) => {
      nodes.sort((a, b) => {
        const sa = a.sequence ?? 0;
        const sb = b.sequence ?? 0;
        if (sa !== sb) return sa - sb;
        return (a.name || "").localeCompare(b.name || "");
      });
      nodes.forEach((n) => sortNodes(n.children));
    };
    sortNodes(roots);
    return roots;
  }, []);

  // 按類型分組資源
  const { systemResources, generalResources } = useMemo(() => {
    const system: ResourceMenuItem[] = [];
    const general: ResourceMenuItem[] = [];
    resources.forEach((r) => {
      if (r.type === AdminResourceType.SYSTEM) {
        system.push(r);
      } else {
        general.push(r);
      }
    });
    return {
      systemResources: system,
      generalResources: general,
    };
  }, [resources]);

  // 系統資源樹
  const systemTree: TreeNode[] = useMemo(() => {
    return buildTree(systemResources);
  }, [systemResources, buildTree]);

  // 一般資源樹
  const generalTree: TreeNode[] = useMemo(() => {
    return buildTree(generalResources);
  }, [generalResources, buildTree]);

  // 構建資源映射表（用於快速查找）- 包含所有資源
  const resourceMap = useMemo(() => {
    const map: Record<string, TreeNode> = {};
    const buildMap = (nodes: TreeNode[]) => {
      nodes.forEach((n) => {
        map[n.id] = n;
        if (n.children && n.children.length > 0) buildMap(n.children);
      });
    };
    buildMap(systemTree);
    buildMap(generalTree);
    return map;
  }, [systemTree, generalTree]);

  // 獲取資源及其所有子資源的 ID 列表（遞歸）
  const getResourceAndChildrenIds = useCallback((resourceId: string, resourceMap: Record<string, TreeNode>): string[] => {
    const ids: string[] = [resourceId];
    const resource = resourceMap[resourceId];
    if (resource && resource.children) {
      resource.children.forEach((child) => {
        ids.push(...getResourceAndChildrenIds(child.id, resourceMap));
      });
    }
    return ids;
  }, []);

  // 獲取根資源的所有子資源的某個 verb 的權限 IDs
  const getChildResourcePermissionsForVerb = useCallback(
    (rootResourceId: string, verbId: string, resourceMap: Record<string, TreeNode>): string[] => {
      const childResourceIds = getResourceAndChildrenIds(rootResourceId, resourceMap).slice(1); // 移除根資源自己
      const permIds: string[] = [];
      childResourceIds.forEach((childId) => {
        const permId = permMap[childId]?.[verbId];
        if (permId) permIds.push(permId);
      });
      return permIds;
    },
    [permMap, getResourceAndChildrenIds]
  );

  // 獲取根資源的所有子資源的所有權限 IDs
  const getChildResourceAllPermissions = useCallback(
    (rootResourceId: string, resourceMap: Record<string, TreeNode>): string[] => {
      const childResourceIds = getResourceAndChildrenIds(rootResourceId, resourceMap).slice(1); // 移除根資源自己
      const permIds: string[] = [];
      childResourceIds.forEach((childId) => {
        verbs.forEach((v) => {
          const permId = permMap[childId]?.[v.id];
          if (permId) permIds.push(permId);
        });
      });
      return permIds;
    },
    [permMap, verbs, getResourceAndChildrenIds]
  );

  const toggleAllForResource = useCallback(
    (resourceId: string) => {
      const set = new Set(value);
      const verbToPerm = permMap[resourceId] || {};
      const allPermIds = verbs.map((v) => verbToPerm[v.id]).filter(Boolean) as string[];
      const allSelected = allPermIds.length > 0 && allPermIds.every((id) => set.has(id));

      // 如果是根資源（沒有權限項目），則控制所有子資源的權限
      if (allPermIds.length === 0) {
        const childPermIds = getChildResourceAllPermissions(resourceId, resourceMap);
        const allChildSelected = childPermIds.length > 0 && childPermIds.every((id) => set.has(id));

        if (allChildSelected) {
          childPermIds.forEach((id) => set.delete(id));
        } else {
          childPermIds.forEach((id) => set.add(id));
        }
      } else {
        // 非根資源的正常邏輯
        if (allSelected) {
          allPermIds.forEach((id) => set.delete(id));
        } else {
          allPermIds.forEach((id) => set.add(id));
        }
      }
      onChange([...set]);
    },
    [value, permMap, verbs, getChildResourceAllPermissions, resourceMap, onChange]
  );

  // 切換根資源的某個 verb 的所有子資源權限
  const toggleVerbForRootResource = useCallback(
    (rootResourceId: string, verbId: string) => {
      const childPermIds = getChildResourcePermissionsForVerb(rootResourceId, verbId, resourceMap);
      if (childPermIds.length === 0) return;

      const set = new Set(value);
      const allSelected = childPermIds.every((id) => set.has(id));

      if (allSelected) {
        childPermIds.forEach((id) => set.delete(id));
      } else {
        childPermIds.forEach((id) => set.add(id));
      }
      onChange([...set]);
    },
    [value, getChildResourcePermissionsForVerb, resourceMap, onChange]
  );

  // 切換「整欄（某 verb）」的所有資源權限（針對特定資源列表）
  const toggleAllForVerb = (verbId: string, resourceList: ResourceMenuItem[]) => {
    const set = new Set(value);
    const permIds: string[] = resourceList.map((r) => permMap[r.id]?.[verbId]).filter(Boolean) as string[];
    if (permIds.length === 0) return;
    const allSelected = permIds.every((id) => set.has(id));
    if (allSelected) permIds.forEach((id) => set.delete(id));
    else permIds.forEach((id) => set.add(id));
    onChange([...set]);
  };

  // 切換「ALL」勾選（針對特定資源列表的所有 verbs）
  const toggleAllGlobal = (resourceList: ResourceMenuItem[]) => {
    const set = new Set(value);
    const permIds: string[] = resourceList.flatMap((r) => verbs.map((v) => permMap[r.id]?.[v.id])).filter(Boolean) as string[];
    if (permIds.length === 0) return;
    const allSelected = permIds.every((id) => set.has(id));
    if (allSelected) permIds.forEach((id) => set.delete(id));
    else permIds.forEach((id) => set.add(id));
    onChange([...set]);
  };

  // 拍平樹狀結構為列（針對特定樹）
  const flattenTree = useCallback((nodes: TreeNode[], depth: number = 0): Array<{ node: TreeNode; depth: number }> => {
    const rows: Array<{ node: TreeNode; depth: number }> = [];
    const walk = (ns: TreeNode[], d: number) => {
      ns.forEach((n) => {
        rows.push({ node: n, depth: d });
        if (n.children && n.children.length > 0) walk(n.children, d + 1);
      });
    };
    walk(nodes, depth);
    return rows;
  }, []);

  const systemFlatRows = useMemo(() => flattenTree(systemTree, 0), [systemTree, flattenTree]);
  const generalFlatRows = useMemo(() => flattenTree(generalTree, 0), [generalTree, flattenTree]);

  // 渲染權限矩陣表格的輔助函數
  const renderPermissionTable = (
    title: string,
    resourceList: ResourceMenuItem[],
    tree: TreeNode[],
    flatRows: Array<{ node: TreeNode; depth: number }>
  ) => {
    if (tree.length === 0) return null;

    return (
      <div className="mb-6 last:mb-0">
        <div className="px-4 py-2 bg-gray-100 dark:bg-white/[0.05] rounded-t-lg border-b border-gray-200 dark:border-gray-700">
          <h3 className="text-sm font-semibold text-gray-700 dark:text-gray-300">{title}</h3>
        </div>
        <div className="border rounded-b-xl overflow-hidden">
          {/* Header (flex layout) */}
          <div className="flex items-center bg-gray-50 dark:bg-white/[0.03] border-b px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-200">
            <div className="shrink-0 w-50">Name</div>
            <div className="shrink-0 w-20">
              <Checkbox
                checked={(() => {
                  const allIds = resourceList.flatMap((r) => verbs.map((v) => permMap[r.id]?.[v.id])).filter(Boolean) as string[];
                  return allIds.length > 0 && allIds.every((id) => value.includes(id));
                })()}
                onChange={() => toggleAllGlobal(resourceList)}
                label="All"
              />
            </div>
            {verbs.map((v) => (
              <div key={v.id} className="flex-1 w-full">
                <Checkbox
                  checked={(() => {
                    const ids = resourceList.map((r) => permMap[r.id]?.[v.id]).filter(Boolean) as string[];
                    return ids.length > 0 && ids.every((id) => value.includes(id));
                  })()}
                  onChange={() => toggleAllForVerb(v.id, resourceList)}
                  label={`${v.displayName} (${v.action})`}
                />
              </div>
            ))}
          </div>
          {/* Body (flex rows) */}
          <div className="divide-y overflow-auto max-h-[420px]">
            {flatRows.map(({ node, depth }) => {
              const isRootResource = depth === 0; // 根資源是 depth === 0 的節點
              const verbToPerm = permMap[node.id] || {};
              const allPermIds = verbs.map((v) => verbToPerm[v.id]).filter(Boolean) as string[];

              // 根資源：檢查所有子資源的權限狀態
              const allSelected = isRootResource
                ? (() => {
                    const childPermIds = getChildResourceAllPermissions(node.id, resourceMap);
                    return childPermIds.length > 0 && childPermIds.every((id) => value.includes(id));
                  })()
                : allPermIds.length > 0 && allPermIds.every((id) => value.includes(id));

              return (
                <div key={node.id} className="flex items-center justify-start px-4 py-3 text-sm">
                  <div className={`flex shrink-0 items-center w-50 ${depth > 0 ? "pl-4" : ""}`}>
                    {resolveIcon(node.icon || "", { className: "size-4" }).icon}
                    <Tooltip content={node.code} placement="bottom">
                      <span className="pl-2">{node.name}</span>
                    </Tooltip>
                  </div>
                  <div className="shrink-0 items-center justify-start w-20">
                    <Checkbox checked={allSelected} onChange={() => toggleAllForResource(node.id)} />
                  </div>
                  {verbs.map((v) => {
                    if (isRootResource) {
                      // 根資源：顯示控制所有子資源該 verb 權限的 checkbox
                      const childPermIds = getChildResourcePermissionsForVerb(node.id, v.id, resourceMap);
                      const checked = childPermIds.length > 0 && childPermIds.every((id) => value.includes(id));

                      return (
                        <div key={v.id} className="flex-1 items-center justify-start w-60">
                          <Checkbox
                            checked={checked}
                            onChange={() => toggleVerbForRootResource(node.id, v.id)}
                            disabled={childPermIds.length === 0}
                            label={childPermIds.length > 0 ? `所有子資源的 ${v.displayName} 權限` : ""}
                            tooltip
                            tooltipPlacement="bottom"
                            className="max-w-50 truncate"
                          />
                        </div>
                      );
                    } else {
                      // 子資源：顯示具體的權限 checkbox
                      const pid = verbToPerm[v.id];
                      const checked = !!pid && value.includes(pid);
                      const fallbackCode = `${node.code || node.key || ""}:${v.action}`;
                      const codeText = pid ? permInfoById[pid]?.code || "" : fallbackCode;
                      return (
                        <div key={v.id} className="flex-1 items-center justify-start shrink-0 w-60">
                          <Checkbox
                            checked={checked}
                            onChange={() => togglePermission(pid)}
                            disabled={!pid}
                            label={codeText}
                            tooltip
                            tooltipPlacement="bottom"
                            className="max-w-50 truncate"
                          />
                        </div>
                      );
                    }
                  })}
                </div>
              );
            })}
          </div>
        </div>
      </div>
    );
  };

  if (loading) return <div className="text-sm text-gray-500">載入權限中...</div>;

  return (
    <div className={`space-y-0 ${className}`}>
      {renderPermissionTable("一般資源", generalResources, generalTree, generalFlatRows)}
      {renderPermissionTable("系統資源", systemResources, systemTree, systemFlatRows)}
    </div>
  );
}
